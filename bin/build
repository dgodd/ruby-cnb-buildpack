#!/usr/bin/env bash
set -eo pipefail

# Set the launchdir variable to be the third argument from the build lifecycle
launchdir=$3

echo "---> Ruby Buildpack"

echo "---> Downloading and extracting ruby"
mkdir -p $launchdir/ruby
touch $launchdir/ruby.toml

ruby_url=https://s3-external-1.amazonaws.com/heroku-buildpack-ruby/heroku-18/ruby-2.5.1.tgz
wget -q -O - "$ruby_url" | tar -xzf - -C "$launchdir/ruby"

# Make ruby and bundler accessible in this script
export PATH=$PATH:$launchdir/ruby/bin
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH:+${LD_LIBRARY_PATH}:}$launchdir/ruby/lib

echo "---> Installing bundler"
gem install bundler

echo "---> Installing gems"
mkdir "$launchdir/bundler"
touch "$launchdir/bundler.toml"

bundle install --jobs=4 --retry=4 --path "$launchdir/bundler" --binstubs "$launchdir/bundler/bin"

# Set default start command
echo 'processes = [{ type = "web", command = "rackup -p 8080"}]' > "$launchdir/launch.toml"
