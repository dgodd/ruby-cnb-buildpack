#!/usr/bin/env bash
set -eo pipefail

# Set the launchdir variable to be the third argument from the build lifecycle
launchdir=$3

echo "---> Ruby Buildpack"

echo "---> Downloading and extracting ruby"
mkdir -p $launchdir/ruby
touch $launchdir/ruby.toml

ruby_url=https://s3-external-1.amazonaws.com/heroku-buildpack-ruby/heroku-18/ruby-2.5.1.tgz
wget -q -O - "$ruby_url" | tar -xzf - -C "$launchdir/ruby"

# Make ruby and bundler accessible in this script
export PATH=$PATH:$launchdir/ruby/bin
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH:+${LD_LIBRARY_PATH}:}$launchdir/ruby/lib

echo "---> Installing bundler"
gem install bundler

### START BUNDLER LAYER
local_bundler_checksum=$(md5sum Gemfile.lock | cut -d' ' -f1)
if [[ -f $launchdir/bundler.toml ]]; then
    remote_bundler_checksum=$(cat "$launchdir/bundler.toml" | yj -t | jq -r .lock_checksum)
fi
echo "BUNDLER CHECKSUMS: $local_bundler_checksum == $remote_bundler_checksum"
if [[ -f Gemfile.lock && $local_bundler_checksum == $remote_bundler_checksum ]] ; then
    echo "---> Reusing gems"
else
    echo "---> Installing gems"
    mkdir "$launchdir/bundler"
    echo "lock_checksum = \"$local_bundler_checksum\"" > "$launchdir/bundler.toml"

    bundle install --jobs=4 --retry=4 --path "$launchdir/bundler" --binstubs "$launchdir/bundler/bin"
fi
### END BUNDLER LAYER

# Set default start command
echo 'processes = [{ type = "web", command = "rackup -p 8080"}]' > "$launchdir/launch.toml"
